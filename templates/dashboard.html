<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VIGIA ‚Äî Panel del Profesor</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üñ•Ô∏è</text></svg>" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    :root {
      --bg: #0f1117;
      --card-bg: #1a1d27;
      --card-border: #2d3148;
      --accent: #4f8ef7;
      --text: #e2e8f0;
      --muted: #718096;
      --green: #48bb78;
      --red: #fc8181;
    }

    * { box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ Cabecera ‚îÄ‚îÄ */
    header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--card-border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header h1 {
      font-size: 1.25rem;
      font-weight: 700;
      margin: 0;
      color: var(--accent);
      letter-spacing: 0.02em;
    }
    header h1 span { color: var(--text); }

    #info-bar {
      display: flex;
      align-items: center;
      gap: 18px;
      font-size: 0.85rem;
      color: var(--muted);
    }
    .pulse-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--green);
      display: inline-block;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50%       { opacity: .5; transform: scale(1.3); }
    }
    #count-badge {
      background: var(--accent);
      color: #fff;
      border-radius: 999px;
      padding: 2px 10px;
      font-weight: 600;
      font-size: 0.8rem;
    }

    /* ‚îÄ‚îÄ Controles ‚îÄ‚îÄ */
    #controls {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 14px;
      flex-wrap: wrap;
    }
    #controls label { font-size: 0.82rem; color: var(--muted); }
    #controls input[type=range] { width: 120px; accent-color: var(--accent); }
    #search-input {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      color: var(--text);
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 0.85rem;
      width: 180px;
    }
    #search-input:focus { outline: none; border-color: var(--accent); }

    /* ‚îÄ‚îÄ Cuadr√≠cula ‚îÄ‚îÄ */
    #grid {
      padding: 16px 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(var(--card-w, 280px), 1fr));
      gap: 14px;
    }

    .student-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.15s, border-color 0.15s, box-shadow 0.15s;
    }
    .student-card:hover {
      transform: translateY(-2px);
      border-color: var(--accent);
      box-shadow: 0 4px 20px rgba(79,142,247,.25);
    }

    .card-screen {
      width: 100%;
      aspect-ratio: 16/9;
      background: #0a0c14;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    .card-screen img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .card-screen .placeholder {
      color: var(--muted);
      font-size: 0.8rem;
      text-align: center;
      line-height: 2;
    }
    .card-screen .placeholder .icon { font-size: 2rem; }

    .card-info {
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .card-name {
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }
    .card-meta {
      font-size: 0.7rem;
      color: var(--muted);
      text-align: right;
      white-space: nowrap;
    }
    .status-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--green);
      flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ Mensaje vac√≠o ‚îÄ‚îÄ */
    #empty-msg {
      display: none;
      text-align: center;
      color: var(--muted);
      padding: 80px 20px;
      font-size: 1rem;
    }
    #empty-msg .icon { font-size: 3rem; display: block; margin-bottom: 10px; }

    /* ‚îÄ‚îÄ Modal pantalla completa ‚îÄ‚îÄ */
    #modal-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,.88);
      z-index: 500;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    #modal-overlay.show { display: flex; }
    #modal-header {
      width: 100%;
      max-width: 1400px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      color: var(--text);
    }
    #modal-name { font-weight: 700; font-size: 1.1rem; }
    #modal-meta { font-size: 0.8rem; color: var(--muted); }
    #modal-close {
      background: none; border: none; color: var(--muted);
      font-size: 1.6rem; cursor: pointer; line-height: 1;
      transition: color .15s;
    }
    #modal-close:hover { color: var(--text); }
    #modal-img {
      max-width: min(1400px, 96vw);
      max-height: calc(96vh - 60px);
      border-radius: 8px;
      border: 1px solid var(--card-border);
      object-fit: contain;
    }
    #modal-timestamp {
      font-size: 0.75rem;
      color: var(--muted);
      padding: 6px;
    }

    /* ‚îÄ‚îÄ Toast notificaciones ‚îÄ‚îÄ */
    #toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 600;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast-item {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 0.83rem;
      animation: slide-in .25s ease;
      max-width: 260px;
    }
    @keyframes slide-in {
      from { opacity:0; transform: translateX(40px); }
      to   { opacity:1; transform: translateX(0); }
    }
    .toast-item.connect  { border-left: 3px solid var(--green); }
    .toast-item.disconnect { border-left: 3px solid var(--red); }

    /* ‚îÄ‚îÄ Bloqueo de alumno ‚îÄ‚îÄ */
    .lock-overlay {
      position: absolute; inset: 0;
      background: rgba(10, 12, 20, 0.88);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      z-index: 10;
      color: var(--red);
      font-weight: 700;
      font-size: 0.95rem;
      letter-spacing: 0.05em;
      pointer-events: none;
    }
    .lock-overlay.show { display: flex; }
    .lock-overlay .lock-icon { font-size: 2rem; }

    .student-card.locked { border-color: #7a3030; }

    .lock-btn {
      background: none;
      border: 1px solid var(--card-border);
      border-radius: 6px;
      color: var(--muted);
      cursor: pointer;
      padding: 3px 7px;
      font-size: 0.8rem;
      line-height: 1.3;
      flex-shrink: 0;
      transition: border-color .15s, color .15s, background .15s;
    }
    .lock-btn:hover            { border-color: var(--red); color: var(--red); }
    .lock-btn.locked           { border-color: var(--red); color: var(--red); background: #2d1a1a; }

    .quit-btn {
      background: none;
      border: 1px solid var(--card-border);
      border-radius: 6px;
      color: var(--muted);
      cursor: pointer;
      padding: 3px 7px;
      font-size: 0.8rem;
      line-height: 1.3;
      flex-shrink: 0;
      transition: border-color .15s, color .15s, background .15s;
    }
    .quit-btn:hover { border-color: #fc8181; color: #fc8181; background: #2d1a1a; }

    .msg-ind-btn {
      background: none;
      border: 1px solid var(--card-border);
      border-radius: 6px;
      color: var(--muted);
      cursor: pointer;
      padding: 3px 7px;
      font-size: 0.8rem;
      line-height: 1.3;
      flex-shrink: 0;
      transition: border-color .15s, color .15s;
    }
    .msg-ind-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* ‚îÄ‚îÄ Barra de mensajes ‚îÄ‚îÄ */
    #msg-bar { padding: 0 20px 12px; }
    #btn-enviar-msg {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 7px 16px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s;
      white-space: nowrap;
    }
    #btn-enviar-msg:hover { background: #3a7de0; }

    /* ‚îÄ‚îÄ Modal redactar mensaje ‚îÄ‚îÄ */
    #compose-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,.78);
      z-index: 700;
      align-items: center;
      justify-content: center;
    }
    #compose-overlay.show { display: flex; }
    #compose-box {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      width: min(620px, 96vw);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 8px 40px rgba(0,0,0,.5);
    }
    #compose-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 13px 18px;
      border-bottom: 1px solid var(--card-border);
      font-weight: 700; font-size: 1rem;
    }
    #compose-header button {
      background: none; border: none;
      color: var(--muted); font-size: 1.4rem;
      cursor: pointer; line-height: 1; transition: color .15s;
    }
    #compose-header button:hover { color: var(--text); }
    .compose-row {
      display: flex;
      align-items: center;
      padding: 8px 18px;
      border-bottom: 1px solid var(--card-border);
      gap: 10px; font-size: 0.88rem;
    }
    .compose-label { color: var(--muted); min-width: 52px; }
    #compose-para  { color: var(--accent); font-weight: 600; }
    #compose-titulo {
      flex: 1; background: transparent; border: none;
      color: var(--text); font-size: 0.92rem; font-weight: 600;
      outline: none;
    }
    .compose-toolbar {
      display: flex; align-items: center; gap: 2px;
      padding: 6px 12px;
      border-bottom: 1px solid var(--card-border);
      background: #13151f; flex-wrap: wrap;
    }
    .tb-btn {
      background: none; border: 1px solid transparent;
      border-radius: 4px; color: var(--text);
      cursor: pointer; padding: 3px 9px;
      font-size: 0.82rem; transition: background .12s, border-color .12s;
      min-width: 28px; font-family: inherit;
    }
    .tb-btn:hover { background: var(--card-bg); border-color: var(--card-border); }
    .tb-sep { width: 1px; height: 18px; background: var(--card-border); margin: 0 4px; flex-shrink: 0; }
    #compose-body {
      min-height: 160px; max-height: 320px;
      padding: 14px 18px;
      color: var(--text); font-size: 0.95rem; line-height: 1.65;
      overflow-y: auto; outline: none;
      background: var(--bg);
    }
    #compose-body:empty::before {
      content: attr(data-placeholder);
      color: var(--muted); pointer-events: none;
    }
    #compose-body ul, #compose-body ol { padding-left: 22px; margin: 4px 0; }
    #compose-body b, #compose-body strong { color: #fff; }
    #compose-footer {
      display: flex; justify-content: flex-end; gap: 10px;
      padding: 12px 18px;
      border-top: 1px solid var(--card-border);
    }
    .compose-cancel {
      background: none; border: 1px solid var(--card-border);
      color: var(--muted); border-radius: 8px;
      padding: 7px 18px; font-size: 0.87rem;
      cursor: pointer; transition: border-color .15s, color .15s;
    }
    .compose-cancel:hover { border-color: var(--text); color: var(--text); }
    .compose-send {
      background: var(--accent); color: #fff; border: none;
      border-radius: 8px; padding: 7px 22px;
      font-size: 0.87rem; font-weight: 600;
      cursor: pointer; transition: background .15s;
    }
    .compose-send:hover { background: #3a7de0; }
    .tb-btn.active { background: #252840; border-color: var(--accent); color: var(--accent); }

    /* ‚îÄ‚îÄ Botones Ver / Controlar en tarjeta ‚îÄ‚îÄ */
    .view-btn, .ctrl-btn {
      background: none; border: 1px solid var(--card-border);
      border-radius: 6px; color: var(--muted); cursor: pointer;
      padding: 3px 6px; font-size: 0.8rem; line-height: 1.3;
      flex-shrink: 0; transition: border-color .15s, color .15s;
    }
    .view-btn:hover { border-color: var(--accent); color: var(--accent); }
    .ctrl-btn:hover { border-color: #f6ad55;       color: #f6ad55; }

    /* ‚îÄ‚îÄ Modal Live View ‚îÄ‚îÄ */
    #liveview-overlay {
      display: none; position: fixed; inset: 0;
      background: #060810; z-index: 850;
      flex-direction: column; outline: none;
    }
    #liveview-overlay.show { display: flex; }
    #liveview-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 16px; flex-shrink: 0;
      background: var(--card-bg); border-bottom: 1px solid var(--card-border);
    }
    #liveview-header-left  { display: flex; align-items: center; gap: 10px; }
    #liveview-name         { font-weight: 700; font-size: 1rem; }
    .lv-badge {
      font-size: 0.72rem; font-weight: 600;
      padding: 2px 10px; border-radius: 999px; border: 1px solid;
    }
    .lv-badge.view    { color: var(--accent); border-color: var(--accent); background: #1a2340; }
    .lv-badge.control { color: #f6ad55;       border-color: #f6ad55;       background: #2d1f0a; }
    #liveview-fps { font-size: 0.78rem; color: var(--muted); }
    #liveview-header button {
      background: none; border: 1px solid var(--card-border); color: var(--muted);
      border-radius: 8px; padding: 5px 12px; cursor: pointer; font-size: 0.83rem;
      transition: border-color .15s, color .15s;
    }
    #liveview-header button:hover { border-color: var(--text); color: var(--text); }
    #liveview-body {
      flex: 1; min-height: 0; overflow: hidden;
      display: flex; align-items: center; justify-content: center;
    }
    #liveview-body.control-mode { cursor: crosshair; }
    #liveview-img {
      max-width: 100%; max-height: 100%; object-fit: contain; display: block;
      user-select: none; -webkit-user-drag: none;
    }

    /* Vista HTML fuente */
    #compose-source {
      display: none;
      min-height: 160px; max-height: 320px;
      width: 100%; padding: 14px 18px; box-sizing: border-box;
      background: #0a0c14; color: #88c07a;
      font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
      font-size: 0.83rem; line-height: 1.55;
      border: none; outline: none; resize: none; overflow-y: auto;
    }
    #compose-source.show { display: block; }
    #compose-body.src-hidden { display: none; }

    /* Mini modal hiperv√≠nculo */
    #link-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.6); z-index: 800;
      align-items: center; justify-content: center;
    }
    #link-overlay.show { display: flex; }
    #link-box {
      background: var(--card-bg); border: 1px solid var(--card-border);
      border-radius: 10px; width: min(380px, 94vw); padding: 18px 20px;
    }
    #link-box h3 { margin: 0 0 14px; font-size: 0.95rem; font-weight: 700; }
    .link-field { margin-bottom: 10px; }
    .link-field label { display: block; font-size: 0.78rem; color: var(--muted); margin-bottom: 4px; }
    .link-field input {
      width: 100%; background: var(--bg); border: 1px solid var(--card-border);
      color: var(--text); border-radius: 6px; padding: 7px 10px;
      font-size: 0.88rem; outline: none; box-sizing: border-box;
    }
    .link-field input:focus { border-color: var(--accent); }
    #link-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 14px; }

    /* ‚îÄ‚îÄ Bot√≥n compartir pantalla ‚îÄ‚îÄ */
    #btn-compartir {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      color: var(--text);
      border-radius: 8px;
      padding: 6px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background .15s, border-color .15s;
      white-space: nowrap;
    }
    #btn-compartir:hover { background: #252840; border-color: var(--accent); }
    #btn-compartir.sharing {
      background: #2d1a1a;
      border-color: var(--red);
      color: var(--red);
      animation: blink-border 1.5s infinite;
    }
    @keyframes blink-border {
      0%, 100% { border-color: var(--red); }
      50%       { border-color: #7a3030; }
    }

    /* Indicador "en directo" en la cabecera */
    #live-badge {
      display: none;
      align-items: center;
      gap: 6px;
      background: #2d1a1a;
      border: 1px solid var(--red);
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 0.75rem;
      color: var(--red);
      font-weight: 600;
    }
    #live-badge.show { display: flex; }
    #live-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--red);
      animation: pulse 1s infinite;
    }

    /* Preview miniatura de lo que se comparte */
    #share-preview {
      display: none;
      width: 140px;
      border-radius: 6px;
      border: 1px solid var(--card-border);
      object-fit: contain;
    }
    #share-preview.show { display: block; }
  </style>
</head>
<body>

<!-- ‚îÄ‚îÄ Cabecera ‚îÄ‚îÄ -->
<header>
  <h1>VIG<span>IA</span></h1>
  <div id="info-bar">
    <span><span class="pulse-dot"></span></span>
    <span>Alumnos conectados: <span id="count-badge">0</span></span>
    <span id="server-status" style="color: var(--muted)">Conectando‚Ä¶</span>
    <div id="live-badge"><span id="live-dot"></span> EN DIRECTO</div>
  </div>
</header>

<!-- ‚îÄ‚îÄ Controles ‚îÄ‚îÄ -->
<div id="controls">
  <label>
    Tama√±o tarjetas
    <input type="range" id="size-slider" min="180" max="520" value="280" step="20" />
  </label>
  <input type="text" id="search-input" placeholder="üîç Buscar alumno‚Ä¶" />
  <button id="btn-compartir" onclick="toggleCompartir()">üì∫ Compartir mi pantalla</button>
  <button id="btn-cerrar-todos" onclick="quitAll()"
          style="background:none;border:1px solid var(--card-border);color:var(--muted);border-radius:8px;padding:6px 14px;font-size:0.85rem;cursor:pointer;transition:border-color .15s,color .15s"
          onmouseover="this.style.borderColor='#fc8181';this.style.color='#fc8181'"
          onmouseout="this.style.borderColor='var(--card-border)';this.style.color='var(--muted)'">‚èª Cerrar todos</button>
  <img id="share-preview" alt="Previsualizaci√≥n" title="Lo que ven los alumnos" />
</div>

<!-- ‚îÄ‚îÄ Barra de mensajes ‚îÄ‚îÄ -->
<div id="msg-bar">
  <button id="btn-enviar-msg" onclick="abrirCompose()">‚úâ Nuevo mensaje</button>
</div>

<!-- ‚îÄ‚îÄ Cuadr√≠cula de alumnos ‚îÄ‚îÄ -->
<div id="grid"></div>
<div id="empty-msg">
  <span class="icon">üì°</span>
  Esperando que los alumnos se conecten‚Ä¶<br />
  <small>Aseg√∫rate de que ejecutan <code>client.py</code> con la IP de este equipo.</small>
</div>

<!-- ‚îÄ‚îÄ Modal vista ampliada ‚îÄ‚îÄ -->
<div id="modal-overlay">
  <div id="modal-header">
    <div>
      <div id="modal-name">‚Äî</div>
      <div id="modal-meta">‚Äî</div>
    </div>
    <button id="modal-close" title="Cerrar (Esc)">‚úï</button>
  </div>
  <img id="modal-img" src="" alt="Pantalla del alumno" />
  <div id="modal-timestamp"></div>
</div>

<!-- ‚îÄ‚îÄ Toast ‚îÄ‚îÄ -->
<div id="toast-container"></div>

<script>
// ‚îÄ‚îÄ Estado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const students = {};  // sid ‚Üí {name, ip, image, last_seen, connected_at}
let modalSid = null;

// ‚îÄ‚îÄ Socket.IO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const socket = io({ transports: ['websocket'] });

socket.on('connect', () => {
  document.getElementById('server-status').textContent = 'Conectado';
  document.getElementById('server-status').style.color = 'var(--green)';
  // Pedir la lista completa (por si reconectamos)
  socket.emit('request_students');
});

socket.on('disconnect', () => {
  document.getElementById('server-status').textContent = 'Sin conexi√≥n';
  document.getElementById('server-status').style.color = 'var(--red)';
});

socket.on('full_student_list', (list) => {
  list.forEach(s => {
    students[s.sid] = {
      name: s.name, ip: s.ip,
      image: s.image, last_seen: s.last_seen,
      connected_at: s.connected_at,
      locked: s.locked || false,
    };
    renderCard(s.sid);
    if (s.locked) updateLockState(s.sid, true);
  });
  updateCount();
  toggleEmpty();
});

socket.on('student_connected', (data) => {
  students[data.sid] = {
    name: data.name, ip: data.ip,
    image: null, last_seen: '‚Äî',
    connected_at: data.connected_at,
  };
  renderCard(data.sid);
  updateCount();
  toggleEmpty();
  toast(`‚úÖ Conectado: ${data.name}`, 'connect');
});

socket.on('student_disconnected', (data) => {
  const name = students[data.sid]?.name || 'Alumno';
  delete students[data.sid];
  removeCard(data.sid);
  updateCount();
  toggleEmpty();
  toast(`‚ùå Desconectado: ${name}`, 'disconnect');
  // Si est√°bamos mirando su pantalla, cerrar modal
  if (modalSid === data.sid) closeModal();
});

socket.on('update_screenshot', (data) => {
  if (!students[data.sid]) return;
  students[data.sid].image = data.image;
  students[data.sid].last_seen = data.last_seen;
  updateCardImage(data.sid, data.image, data.last_seen);
  if (modalSid === data.sid) updateModal(data.sid);
});

// ‚îÄ‚îÄ Renderizado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCard(sid) {
  // Si ya existe, solo actualizar metadatos
  if (document.getElementById(`card-${sid}`)) {
    const el = document.getElementById(`card-${sid}`);
    el.querySelector('.card-name').textContent = students[sid].name;
    return;
  }
  const s = students[sid];
  const div = document.createElement('div');
  div.className = 'student-card';
  div.id = `card-${sid}`;
  div.dataset.name = s.name.toLowerCase();
  div.innerHTML = `
    <div class="card-screen" id="screen-${sid}">
      <div class="placeholder"><span class="icon">‚è≥</span>Esperando captura‚Ä¶</div>
      <div class="lock-overlay" id="lock-overlay-${sid}">
        <span class="lock-icon">üîí</span>BLOQUEADO
      </div>
    </div>
    <div class="card-info">
      <span class="status-dot"></span>
      <span class="card-name" title="${escHtml(s.name)}">${escHtml(s.name)}</span>
      <span class="card-meta" id="meta-${sid}">${escHtml(s.ip)}</span>
      <button class="msg-ind-btn"
              title="Enviar mensaje a este alumno"
              onclick="event.stopPropagation(); abrirMsgInd('${sid}')">‚úâ</button>
      <button class="view-btn"
              title="Ver pantalla en directo (solo ver)"
              onclick="event.stopPropagation(); abrirLiveView('${sid}','view')">üëÅ</button>
      <button class="ctrl-btn"
              title="Control remoto"
              onclick="event.stopPropagation(); abrirLiveView('${sid}','control')">üñ±</button>
      <button class="lock-btn" id="lock-btn-${sid}"
              title="Bloquear pantalla"
              onclick="event.stopPropagation(); toggleLock('${sid}')">üîí</button>
      <button class="quit-btn"
              title="Cerrar aplicaci√≥n del alumno"
              onclick="event.stopPropagation(); quitStudent('${sid}')">‚èª</button>
    </div>`;
  div.addEventListener('click', () => openModal(sid));
  document.getElementById('grid').appendChild(div);

  if (s.image) updateCardImage(sid, s.image, s.last_seen);
  applySearch();
}

function updateCardImage(sid, image, last_seen) {
  const screen = document.getElementById(`screen-${sid}`);
  if (!screen) return;
  let img = screen.querySelector('img');
  if (!img) {
    screen.innerHTML = '';
    img = document.createElement('img');
    img.alt = 'Pantalla';
    screen.appendChild(img);
  }
  img.src = image;
  const meta = document.getElementById(`meta-${sid}`);
  if (meta) meta.textContent = last_seen;
}

function removeCard(sid) {
  document.getElementById(`card-${sid}`)?.remove();
}

function updateCount() {
  document.getElementById('count-badge').textContent = Object.keys(students).length;
}

function toggleEmpty() {
  const empty = Object.keys(students).length === 0;
  document.getElementById('empty-msg').style.display = empty ? 'block' : 'none';
}

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(sid) {
  modalSid = sid;
  updateModal(sid);
  document.getElementById('modal-overlay').classList.add('show');
}

function updateModal(sid) {
  const s = students[sid];
  if (!s) return;
  document.getElementById('modal-name').textContent = s.name;
  document.getElementById('modal-meta').textContent = `IP: ${s.ip}  |  Conectado: ${s.connected_at}`;
  document.getElementById('modal-timestamp').textContent = `√öltima captura: ${s.last_seen}`;
  if (s.image) document.getElementById('modal-img').src = s.image;
}

function closeModal() {
  modalSid = null;
  document.getElementById('modal-overlay').classList.remove('show');
}

document.getElementById('modal-close').addEventListener('click', closeModal);
document.getElementById('modal-overlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
});
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

// ‚îÄ‚îÄ Controles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('size-slider').addEventListener('input', (e) => {
  document.getElementById('grid').style.setProperty('--card-w', e.target.value + 'px');
});

document.getElementById('search-input').addEventListener('input', applySearch);

function applySearch() {
  const q = document.getElementById('search-input').value.toLowerCase();
  document.querySelectorAll('.student-card').forEach(card => {
    card.style.display = card.dataset.name.includes(q) ? '' : 'none';
  });
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg, type = '') {
  const el = document.createElement('div');
  el.className = `toast-item ${type}`;
  el.textContent = msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// ‚îÄ‚îÄ Utilidades ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function escHtml(s) {
  return String(s)
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ‚îÄ‚îÄ Cerrar cliente de alumnos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function quitStudent(sid) {
  const name = students[sid]?.name || 'este alumno';
  if (!confirm(`¬øCerrar la aplicaci√≥n de ${name}?`)) return;
  socket.emit('quit_student', { sid });
}

function quitAll() {
  const n = Object.keys(students).length;
  if (n === 0) { toast('No hay alumnos conectados.', ''); return; }
  if (!confirm(`¬øCerrar la aplicaci√≥n en los ${n} equipo(s) conectado(s)?`)) return;
  socket.emit('quit_all_students', {});
  toast(`‚èª Cerrando ${n} cliente(s)‚Ä¶`, 'disconnect');
}

// ‚îÄ‚îÄ Redactar mensaje (individual o a todos) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _composeSid = null;   // null = todos los alumnos

function abrirCompose(sid = null) {
  _composeSid = sid || null;
  // Salir de modo fuente si estaba activo
  if (typeof _sourceMode !== 'undefined' && _sourceMode) toggleSource();
  document.getElementById('compose-para').textContent =
    sid ? (students[sid]?.name || sid) : 'Todos los alumnos';
  document.getElementById('compose-titulo').value = 'Mensaje del profesor';
  document.getElementById('compose-body').innerHTML = '';
  document.getElementById('compose-overlay').classList.add('show');
  setTimeout(() => document.getElementById('compose-body').focus(), 60);
}

// Alias para el bot√≥n ‚úâ de las tarjetas
function abrirMsgInd(sid) { abrirCompose(sid); }

function cerrarCompose() {
  _composeSid = null;
  document.getElementById('compose-overlay').classList.remove('show');
}

function enviarCompose() {
  // Si estamos en modo fuente, sincronizar al cuerpo visual primero
  if (typeof _sourceMode !== 'undefined' && _sourceMode) toggleSource();
  const titulo = document.getElementById('compose-titulo').value.trim()
                 || 'Mensaje del profesor';
  const body   = document.getElementById('compose-body').innerHTML.trim();
  // Ignorar si solo hay un <br> vac√≠o
  if (!body || body === '<br>') {
    document.getElementById('compose-body').focus();
    return;
  }
  if (_composeSid) {
    socket.emit('send_message_to', { sid: _composeSid, title: titulo, body });
    toast(`‚úâ Mensaje enviado a ${students[_composeSid]?.name || _composeSid}`, 'connect');
  } else {
    if (Object.keys(students).length === 0) {
      toast('No hay alumnos conectados.', '');
      return;
    }
    socket.emit('send_message', { title: titulo, body });
    toast(`‚úâ Mensaje enviado a ${Object.keys(students).length} alumno(s)`, 'connect');
  }
  cerrarCompose();
}

function fmt(cmd) {
  document.getElementById('compose-body').focus();
  document.execCommand(cmd, false, null);
}

// ‚îÄ‚îÄ Vista HTML fuente ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _sourceMode = false;

function toggleSource() {
  const body = document.getElementById('compose-body');
  const src  = document.getElementById('compose-source');
  const btn  = document.getElementById('btn-source');
  if (!_sourceMode) {
    src.value = body.innerHTML;
    body.classList.add('src-hidden');
    src.classList.add('show');
    btn.classList.add('active');
    src.focus();
  } else {
    body.innerHTML = src.value;
    src.classList.remove('show');
    body.classList.remove('src-hidden');
    btn.classList.remove('active');
    body.focus();
  }
  _sourceMode = !_sourceMode;
}

// ‚îÄ‚îÄ Insertar hiperv√≠nculo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _linkRange = null;

function abrirLink() {
  const sel = window.getSelection();
  _linkRange = sel?.rangeCount ? sel.getRangeAt(0).cloneRange() : null;
  document.getElementById('link-text').value = sel?.toString() || '';
  document.getElementById('link-url').value  = '';
  document.getElementById('link-overlay').classList.add('show');
  setTimeout(() => {
    const f = document.getElementById(
      document.getElementById('link-text').value ? 'link-url' : 'link-text'
    );
    f.focus();
  }, 50);
}

function cerrarLink() {
  _linkRange = null;
  document.getElementById('link-overlay').classList.remove('show');
}

function insertarLink() {
  const url   = document.getElementById('link-url').value.trim();
  const texto = document.getElementById('link-text').value.trim();
  if (!url) { document.getElementById('link-url').focus(); return; }
  const label = texto || url;
  const body  = document.getElementById('compose-body');
  body.focus();
  if (_linkRange) {
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(_linkRange);
  }
  document.execCommand('insertHTML', false,
    `<a href="${escHtml(url)}">${escHtml(label)}</a>`);
  cerrarLink();
}

// ‚îÄ‚îÄ Bloqueo de alumno ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
socket.on('student_lock_state', (data) => {
  if (students[data.sid]) {
    students[data.sid].locked = data.locked;
    updateLockState(data.sid, data.locked);
  }
});

function toggleLock(sid) {
  if (!students[sid]) return;
  const nuevoEstado = !students[sid].locked;
  // Actualizaci√≥n optimista
  students[sid].locked = nuevoEstado;
  updateLockState(sid, nuevoEstado);
  socket.emit('lock_student', { sid, locked: nuevoEstado });
}

function updateLockState(sid, locked) {
  const card    = document.getElementById(`card-${sid}`);
  const overlay = document.getElementById(`lock-overlay-${sid}`);
  const btn     = document.getElementById(`lock-btn-${sid}`);
  if (!card) return;

  if (locked) {
    card.classList.add('locked');
    overlay?.classList.add('show');
    if (btn) { btn.classList.add('locked'); btn.title = 'Desbloquear pantalla'; btn.textContent = 'üîì'; }
  } else {
    card.classList.remove('locked');
    overlay?.classList.remove('show');
    if (btn) { btn.classList.remove('locked'); btn.title = 'Bloquear pantalla'; btn.textContent = 'üîí'; }
  }
}

// ‚îÄ‚îÄ Live View / Control remoto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _liveviewSid   = null;
let _liveviewMode  = 'view';
let _liveOrigW = 1280, _liveOrigH = 720;
let _lastMouseSend = 0, _liveFps = 0, _liveFpsTs = 0;
let _pc = null, _dc = null, _webrtcActivo = false;
const _STUN = [{ urls:'stun:stun.l.google.com:19302' },
               { urls:'stun:stun1.l.google.com:19302' }];

socket.on('live_frame', (data) => {
  if (data.sid !== _liveviewSid) return;
  document.getElementById('liveview-img').src = data.image;
  _liveOrigW = data.orig_w || 1280;
  _liveOrigH = data.orig_h || 720;
  _liveFps++;
  const now = Date.now();
  if (now - _liveFpsTs >= 1000) {
    document.getElementById('liveview-fps').textContent = `${_liveFps} fps`;
    _liveFps = 0; _liveFpsTs = now;
  }
});

socket.on('student_view_ended', (data) => {
  if (data.sid === _liveviewSid) cerrarLiveView();
});

function abrirLiveView(sid, mode) {
  _liveviewSid  = sid;
  _liveviewMode = mode;
  _liveOrigW = 1280; _liveOrigH = 720;
  _liveFps = 0; _liveFpsTs = Date.now();

  document.getElementById('liveview-name').textContent = students[sid]?.name || sid;
  const badge = document.getElementById('liveview-badge');
  const body  = document.getElementById('liveview-body');
  if (mode === 'control') {
    badge.textContent = 'üñ± Control remoto';
    badge.className   = 'lv-badge control';
    body.classList.add('control-mode');
  } else {
    badge.textContent = 'üëÅ Solo ver';
    badge.className   = 'lv-badge view';
    body.classList.remove('control-mode');
  }
  document.getElementById('liveview-fps').textContent = '‚Ä¶';
  document.getElementById('liveview-img').src = students[sid]?.image || '';

  socket.emit('start_view', { sid, mode });
  const ov = document.getElementById('liveview-overlay');
  ov.classList.add('show');
  ov.focus();
  _iniciarWebRTC(sid, mode);
}

function cerrarLiveView() {
  if (_liveviewSid) socket.emit('stop_view', { sid: _liveviewSid });
  _liveviewSid = null;
  document.getElementById('liveview-overlay').classList.remove('show');
  document.getElementById('liveview-body').classList.remove('control-mode');
  document.getElementById('liveview-img').src = '';
  if (_pc) { _pc.close(); _pc = null; }
  _dc = null; _webrtcActivo = false;
  const vid = document.getElementById('liveview-video');
  vid.srcObject = null; vid.style.display = 'none';
  document.getElementById('liveview-img').style.display = 'block';
  document.getElementById('liveview-transport').textContent = 'JPEG';
  document.getElementById('liveview-transport').style.color = 'var(--muted)';
}

// ‚îÄ‚îÄ WebRTC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function _iniciarWebRTC(sid, mode) {
  if (typeof RTCPeerConnection === 'undefined') return;
  try {
    if (_pc) { _pc.close(); _pc = null; _dc = null; }
    _pc = new RTCPeerConnection({ iceServers: _STUN });

    if (mode === 'control') {
      _dc = _pc.createDataChannel('vigia-input', { ordered:false, maxRetransmits:0 });
      // readyState se comprueba en _enviarInput; no tocamos _webrtcActivo desde el DC
    }

    _pc.ontrack = (ev) => {
      if (ev.track.kind !== 'video') return;
      const vid = document.getElementById('liveview-video');
      vid.srcObject = ev.streams[0];
      vid.onloadedmetadata = () => {
        const s = ev.streams[0].getVideoTracks()[0].getSettings();
        _liveOrigW = s.width  || _liveOrigW;
        _liveOrigH = s.height || _liveOrigH;
      };
      vid.style.display = 'block';
      document.getElementById('liveview-img').style.display = 'none';
      _webrtcActivo = true;  // P2P de v√≠deo establecido (view y control)
      document.getElementById('liveview-transport').textContent = 'WebRTC P2P';
      document.getElementById('liveview-transport').style.color = 'var(--green)';
    };

    _pc.onicecandidate = (ev) => {
      if (ev.candidate)
        socket.emit('webrtc_ice', { sid, candidate: {
          candidate:     ev.candidate.candidate,
          sdpMid:        ev.candidate.sdpMid,
          sdpMLineIndex: ev.candidate.sdpMLineIndex
        }});
    };

    _pc.oniceconnectionstatechange = () => {
      if (['failed','disconnected'].includes(_pc?.iceConnectionState))
        _fallbackJPEG('ICE ' + _pc.iceConnectionState);
    };

    const offer = await _pc.createOffer({ offerToReceiveVideo:true, offerToReceiveAudio:false });
    await _pc.setLocalDescription(offer);
    socket.emit('webrtc_offer', { sid, sdp: { sdp:_pc.localDescription.sdp, type:_pc.localDescription.type } });

    // Fallback si en 8s no hay v√≠deo
    setTimeout(() => { if (!_webrtcActivo && _liveviewSid === sid) _fallbackJPEG('timeout'); }, 8000);
  } catch(e) {
    _fallbackJPEG(e.message);
  }
}

socket.on('webrtc_answer', async (data) => {
  if (data.sid !== _liveviewSid || !_pc) return;
  try { await _pc.setRemoteDescription(new RTCSessionDescription(data.sdp)); }
  catch(e) { _fallbackJPEG(e.message); }
});

socket.on('webrtc_ice', async (data) => {
  if (data.sid !== _liveviewSid || !_pc) return;
  try { if (data.candidate?.candidate) await _pc.addIceCandidate(new RTCIceCandidate(data.candidate)); }
  catch(e) { /* ignorar candidatos tard√≠os */ }
});

function _fallbackJPEG(razon) {
  if (_webrtcActivo) return;
  console.log('[WebRTC] Fallback JPEG:', razon);
  const vid = document.getElementById('liveview-video');
  vid.style.display = 'none'; vid.srcObject = null;
  document.getElementById('liveview-img').style.display = 'block';
  document.getElementById('liveview-transport').textContent = 'JPEG';
  document.getElementById('liveview-transport').style.color = 'var(--muted)';
  if (_pc) { _pc.close(); _pc = null; _dc = null; }
}

function _enviarInput(payload) {
  if (_webrtcActivo && _dc?.readyState === 'open')
    _dc.send(JSON.stringify(payload));
  else
    socket.emit('remote_input', payload);
}

// Traducci√≥n de teclas del navegador a nombres de pyautogui
function _mapKey(key) {
  const m = {
    ' ':'space','Enter':'enter','Escape':'esc','Tab':'tab',
    'Backspace':'backspace','Delete':'delete','Insert':'insert',
    'Home':'home','End':'end','PageUp':'pageup','PageDown':'pagedown',
    'ArrowLeft':'left','ArrowRight':'right','ArrowUp':'up','ArrowDown':'down',
    'F1':'f1','F2':'f2','F3':'f3','F4':'f4','F5':'f5','F6':'f6',
    'F7':'f7','F8':'f8','F9':'f9','F10':'f10','F11':'f11','F12':'f12',
    'Control':'ctrl','Alt':'alt','Shift':'shift','Meta':'win',
    'CapsLock':'capslock','NumLock':'numlock',
  };
  return m[key] ?? (key.length === 1 ? key : null);
}

function _traducirCoords(e) {
  const el   = _webrtcActivo
    ? document.getElementById('liveview-video')
    : document.getElementById('liveview-img');
  const rect = el.getBoundingClientRect();
  return {
    x: Math.round((e.clientX - rect.left) / rect.width  * _liveOrigW),
    y: Math.round((e.clientY - rect.top)  / rect.height * _liveOrigH),
  };
}

// Listeners del overlay de live view
// (el div #liveview-overlay est√° despu√©s del <\/script>, se registra al estar listo el DOM)
document.addEventListener('DOMContentLoaded', function () {
  const ov   = document.getElementById('liveview-overlay');
  const body = document.getElementById('liveview-body');

  ov.addEventListener('keydown', (e) => {
    if (!_liveviewSid) return;
    if (e.key === 'Escape') { cerrarLiveView(); return; }
    if (_liveviewMode !== 'control') return;
    e.preventDefault();
    const key = _mapKey(e.key);
    if (key) _enviarInput({ sid: _liveviewSid, type: 'keydown', key });
  });

  ov.addEventListener('keyup', (e) => {
    if (!_liveviewSid || _liveviewMode !== 'control' || e.key === 'Escape') return;
    e.preventDefault();
    const key = _mapKey(e.key);
    if (key) _enviarInput({ sid: _liveviewSid, type: 'keyup', key });
  });

  body.addEventListener('mousemove', (e) => {
    if (_liveviewMode !== 'control' || !_liveviewSid) return;
    const now = Date.now();
    if (now - _lastMouseSend < 50) return;   // throttle ‚âà 20 eventos/s
    _lastMouseSend = now;
    const { x, y } = _traducirCoords(e);
    _enviarInput({ sid: _liveviewSid, type: 'mousemove', x, y });
  });

  body.addEventListener('mousedown', (e) => {
    if (_liveviewMode !== 'control' || !_liveviewSid) return;
    e.preventDefault();
    const { x, y } = _traducirCoords(e);
    const btn = ['left','middle','right'][e.button] || 'left';
    _enviarInput({ sid: _liveviewSid, type: 'mousedown', x, y, button: btn });
  });

  body.addEventListener('mouseup', (e) => {
    if (_liveviewMode !== 'control' || !_liveviewSid) return;
    const { x, y } = _traducirCoords(e);
    const btn = ['left','middle','right'][e.button] || 'left';
    _enviarInput({ sid: _liveviewSid, type: 'mouseup', x, y, button: btn });
  });

  body.addEventListener('contextmenu', (e) => {
    if (_liveviewMode === 'control') e.preventDefault();
  });

  body.addEventListener('wheel', (e) => {
    if (_liveviewMode !== 'control' || !_liveviewSid) return;
    e.preventDefault();
    const { x, y } = _traducirCoords(e);
    _enviarInput({
      sid: _liveviewSid, type: 'scroll', x, y,
      dy: Math.round(-e.deltaY / 100),
    });
  }, { passive: false });
});

// ‚îÄ‚îÄ Compartir pantalla del profesor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _shareStream   = null;
let _shareRunning  = false;
let _shareTimeout  = null;
const _shareVideo  = document.createElement('video');
const _shareCanvas = document.createElement('canvas');
const _shareCtx    = _shareCanvas.getContext('2d');
_shareCtx.imageSmoothingEnabled = true;
_shareCtx.imageSmoothingQuality = 'high';
_shareVideo.autoplay    = true;
_shareVideo.muted       = true;
_shareVideo.playsInline = true;

const FPS_SHARE    = 2;      // fotogramas por segundo enviados
const CALIDAD_SHARE = 0.85;  // calidad JPEG 0-1
const ANCHO_SHARE   = 1280;  // px m√°ximos de ancho (bajado para mayor fluidez)

async function toggleCompartir() {
  if (_shareStream) {
    detenerCompartir();
    return;
  }

  if (!navigator.mediaDevices?.getDisplayMedia) {
    const esSeguro = location.protocol === 'https:' ||
                     ['localhost', '127.0.0.1'].includes(location.hostname);
    alert(esSeguro
      ? 'Tu navegador no soporta compartir pantalla.\nUsa Chrome, Edge o Firefox recientes.'
      : 'Para compartir pantalla accede desde esta misma m√°quina:\nhttp://localhost:5000\n(Chrome bloquea esta funci√≥n en conexiones HTTP externas)');
    return;
  }

  try {
    // getDisplayMedia abre el selector nativo de Chrome (pantalla, ventana o pesta√±a)
    _shareStream = await navigator.mediaDevices.getDisplayMedia({
      video: { frameRate: { ideal: 5, max: 10 } },
      audio: false,
    });

    _shareVideo.srcObject = _shareStream;
    _shareStream.getVideoTracks()[0].addEventListener('ended', detenerCompartir);

    // Esperar a que el v√≠deo est√© realmente reproduciendo antes de capturar frames
    await _shareVideo.play();

    _shareRunning = true;
    _loopCompartir();
    _actualizarBoton(true);

  } catch (err) {
    console.error('Error al compartir pantalla:', err);
    // Limpiar el stream si se obtuvo antes de que fallara play()
    if (_shareStream) { _shareStream.getTracks().forEach(t => t.stop()); _shareStream = null; }
    _shareRunning = false;
    if (err.name !== 'NotAllowedError') alert('No se pudo compartir la pantalla: ' + err.message);
  }
}

function _loopCompartir() {
  if (!_shareRunning || !_shareStream) return;
  
  _enviarFrame();
  
  // Controlar FPS manualmente con setTimeout dentro del loop
  _shareTimeout = setTimeout(() => {
    if (_shareRunning) requestAnimationFrame(_loopCompartir);
  }, 1000 / FPS_SHARE);
}

function _enviarFrame() {
  if (!_shareStream || !_shareVideo.videoWidth) return;
  try {
    const vw = _shareVideo.videoWidth;
    const vh = _shareVideo.videoHeight;
    _shareCanvas.width  = Math.min(vw, ANCHO_SHARE);
    _shareCanvas.height = Math.round(_shareCanvas.width * vh / vw);
    
    _shareCtx.drawImage(_shareVideo, 0, 0, _shareCanvas.width, _shareCanvas.height);
    const imgData = _shareCanvas.toDataURL('image/jpeg', CALIDAD_SHARE);
    socket.emit('teacher_screenshot', { image: imgData, activa: true });

    const prev = document.getElementById('share-preview');
    prev.src = imgData;
    if (!prev.classList.contains('show')) prev.classList.add('show');
  } catch (e) {
    console.warn('Error capturando frame:', e);
  }
}

function detenerCompartir() {
  _shareRunning = false;
  clearTimeout(_shareTimeout);
  if (_shareStream) {
    _shareStream.getTracks().forEach(t => t.stop());
    _shareStream = null;
  }
  _shareVideo.srcObject = null;
  socket.emit('teacher_screenshot', { activa: false });
  _actualizarBoton(false);
  const prev = document.getElementById('share-preview');
  prev.src = '';
  prev.classList.remove('show');
}

function _actualizarBoton(compartiendo) {
  const btn   = document.getElementById('btn-compartir');
  const badge = document.getElementById('live-badge');
  if (compartiendo) {
    btn.textContent = '‚èπ Dejar de compartir';
    btn.classList.add('sharing');
    badge.classList.add('show');
  } else {
    btn.textContent = 'üì∫ Compartir mi pantalla';
    btn.classList.remove('sharing');
    badge.classList.remove('show');
  }
}

// Detener al cerrar/recargar la p√°gina
window.addEventListener('beforeunload', () => {
  if (_shareStream) detenerCompartir();
});

// Cerrar compose con Escape; Ctrl+Enter env√≠a
document.addEventListener('keydown', (e) => {
  if (!document.getElementById('compose-overlay').classList.contains('show')) return;
  if (e.key === 'Escape') cerrarCompose();
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) enviarCompose();
});

// Listeners modal hiperv√≠nculo
document.getElementById('link-url').addEventListener('keydown', (e) => {
  if (e.key === 'Enter')  insertarLink();
  if (e.key === 'Escape') cerrarLink();
});
document.getElementById('link-text').addEventListener('keydown', (e) => {
  if (e.key === 'Escape') cerrarLink();
});
document.getElementById('link-overlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('link-overlay')) cerrarLink();
});
document.getElementById('compose-overlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('compose-overlay')) cerrarCompose();
});
</script>

<!-- ‚îÄ‚îÄ Modal redactar mensaje ‚îÄ‚îÄ -->
<div id="compose-overlay">
  <div id="compose-box">
    <div id="compose-header">
      <span>‚úâ Nuevo mensaje</span>
      <button onclick="cerrarCompose()">‚úï</button>
    </div>
    <div class="compose-row">
      <span class="compose-label">Para:</span>
      <span id="compose-para">Todos los alumnos</span>
    </div>
    <div class="compose-row">
      <span class="compose-label">Asunto:</span>
      <input id="compose-titulo" type="text"
             value="Mensaje del profesor" maxlength="120" />
    </div>
    <div class="compose-toolbar">
      <button class="tb-btn" onclick="fmt('bold')"    title="Negrita (Ctrl+B)"><b>N</b></button>
      <button class="tb-btn" onclick="fmt('italic')"  title="Cursiva (Ctrl+I)"><i>K</i></button>
      <button class="tb-btn" onclick="fmt('underline')" title="Subrayado (Ctrl+U)"><u>S</u></button>
      <span class="tb-sep"></span>
      <button class="tb-btn" onclick="fmt('insertUnorderedList')" title="Lista con vi√±etas">‚Ä¢ ‚Äî</button>
      <button class="tb-btn" onclick="fmt('insertOrderedList')"  title="Lista numerada">1. ‚Äî</button>
      <span class="tb-sep"></span>
      <button class="tb-btn" onclick="fmt('removeFormat')" title="Quitar formato">‚úï fmt</button>
      <span class="tb-sep"></span>
      <button class="tb-btn" id="btn-link"   onclick="abrirLink()"    title="Insertar hiperv√≠nculo">üîó Enlace</button>
      <button class="tb-btn" id="btn-source" onclick="toggleSource()" title="Editar HTML fuente">&lt;/&gt; HTML</button>
    </div>
    <div id="compose-body" contenteditable="true" spellcheck="true"
         data-placeholder="Escribe el cuerpo del mensaje aqu√≠‚Ä¶"></div>
    <textarea id="compose-source" spellcheck="false"
              placeholder="<!-- HTML del mensaje -->"></textarea>
    <div id="compose-footer">
      <button class="compose-cancel" onclick="cerrarCompose()">Cancelar</button>
      <button class="compose-send"   onclick="enviarCompose()">Enviar  <small style="font-weight:400;opacity:.7">(Ctrl+‚Üµ)</small></button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Modal Live View / Control remoto ‚îÄ‚îÄ -->
<div id="liveview-overlay" tabindex="0">
  <div id="liveview-header">
    <div id="liveview-header-left">
      <span id="liveview-name">‚Äî</span>
      <span id="liveview-badge" class="lv-badge view">üëÅ Solo ver</span>
      <span id="liveview-transport" style="font-size:0.75rem;color:var(--muted);margin-left:8px;">JPEG</span>
    </div>
    <span id="liveview-fps">‚Ä¶</span>
    <button onclick="cerrarLiveView()">‚úï Cerrar (Esc)</button>
  </div>
  <div id="liveview-body">
    <img id="liveview-img" draggable="false" alt="Pantalla del alumno" />
    <video id="liveview-video" autoplay playsinline muted
           style="display:none;max-width:100%;max-height:100%;"></video>
  </div>
</div>

<!-- ‚îÄ‚îÄ Mini modal hiperv√≠nculo ‚îÄ‚îÄ -->
<div id="link-overlay">
  <div id="link-box">
    <h3>üîó Insertar hiperv√≠nculo</h3>
    <div class="link-field">
      <label>Texto del enlace</label>
      <input id="link-text" type="text" placeholder="Texto visible‚Ä¶" maxlength="200" />
    </div>
    <div class="link-field">
      <label>URL</label>
      <input id="link-url" type="url" placeholder="https://‚Ä¶" />
    </div>
    <div id="link-footer">
      <button class="compose-cancel" onclick="cerrarLink()">Cancelar</button>
      <button class="compose-send"   onclick="insertarLink()">Insertar</button>
    </div>
  </div>
</div>

</body>
</html>
